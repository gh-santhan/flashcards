<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>LM Study – Flashcards</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0b0c10; --panel:#12141a; --panel2:#0e1015; --border:#1e2128;
      --text:#e6edf3; --muted:#9aa4b2; --accent:#3ea6ff;
      --good:#2ecc71; --hard:#f1c40f; --again:#e74c3c;
      --pill:#2d333b; --pillText:#c9d1d9;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;background:var(--bg);color:var(--text)}
    header,footer{background:var(--panel2);border-bottom:1px solid var(--border);padding:12px 16px}
    header .row{display:flex;align-items:center;gap:12px;justify-content:space-between;max-width:1200px;margin:0 auto}
    .brand{font-weight:700;letter-spacing:.2px}
    .status{font-size:12px;color:var(--muted)}
    .status strong{color:var(--text)}
    main{max-width:1200px;margin:0 auto;padding:16px}
    .bar{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
    .pill{background:var(--pill);color:var(--pillText);border:1px solid var(--border);padding:6px 10px;border-radius:999px;font-size:12px}
    .tabs{display:flex;gap:8px;margin:10px 0 16px}
    .tab{padding:8px 12px;border:1px solid var(--border);background:var(--panel);border-radius:8px;cursor:pointer}
    .tab.active{outline:2px solid var(--accent)}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:16px;margin:10px 0}
    .q{font-weight:600;margin:0 0 8px 0}
    .a{margin:12px 0 0 0;white-space:pre-wrap}
    .controls{display:flex;gap:8px;margin-top:12px;flex-wrap:wrap}
    button{background:#1f6feb;color:#fff;border:none;border-radius:8px;padding:8px 12px;cursor:pointer}
    button.sec{background:transparent;border:1px solid var(--border);color:var(--text)}
    button.good{background:var(--good)}
    button.hard{background:var(--hard);color:#000}
    button.again{background:var(--again)}
    input,select,textarea{background:var(--panel2);color:var(--text);border:1px solid var(--border);border-radius:8px;padding:8px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:900px){.grid{grid-template-columns:1fr}}
    .hidden{display:none}
    .sep{height:1px;background:var(--border);margin:12px 0}
    .muted{color:var(--muted)}
    .warning{color:#ffb86b}
    .danger{color:#ff6b6b}
    .ok{color:#2ecc71}
    .list{display:flex;flex-direction:column;gap:8px}
    code.inline{background:#0b1020;border:1px solid #1a2030;padding:2px 6px;border-radius:6px}
    .login-box{display:flex;gap:8px;flex-wrap:wrap}
  </style>
</head>
<body>
<header>
  <div class="row">
    <div>
      <div class="brand">LM Study</div>
      <div class="status" id="authStatus">Not signed in</div>
    </div>
    <div class="login-box">
      <input id="email" type="email" placeholder="you@example.com" />
      <button id="sendLink">Send magic link</button>
      <button id="logout" class="sec hidden">Logout</button>
    </div>
  </div>
</header>

<main>
  <div class="bar">
    <span class="pill">Redirect: <code class="inline" id="redir"></code></span>
    <span class="pill">Role: <strong id="rolePill">—</strong></span>
    <span class="pill">User: <strong id="userPill">—</strong></span>
  </div>

  <div class="tabs">
    <button class="tab active" data-tab="study">Study</button>
    <button class="tab" data-tab="editor">Editor</button>
    <button class="tab" data-tab="admin">Admin</button>
  </div>

  <!-- STUDY -->
  <section id="study" class="">
    <div class="grid">
      <div>
        <label>Chapter</label>
        <select id="chapterFilter"></select>
      </div>
      <div>
        <label>Search</label>
        <input id="search" placeholder="front/back contains…" />
      </div>
    </div>
    <div class="sep"></div>
    <div id="deck"></div>
  </section>

  <!-- EDITOR -->
  <section id="editor" class="hidden">
    <p class="muted">Upload a <code class="inline">{"cards":[...]}</code> JSON. Only roles <b>editor</b> or <b>admin</b> can write.</p>
    <textarea id="jsonInput" rows="12" style="width:100%;" placeholder='{"cards":[...]}'></textarea>
    <div class="controls">
      <button id="preview">Preview</button>
      <button id="import">Import to DB</button>
    </div>
    <div id="previewOut"></div>
  </section>

  <!-- ADMIN -->
  <section id="admin" class="hidden">
    <h3>Users</h3>
    <div id="users" class="list"></div>
  </section>
</main>

<footer>
  <div class="row" style="justify-content:space-between">
    <span class="muted">Persisted grades; no auto-refresh. Build: ui-stable</span>
    <span class="muted">If the magic link still opens localhost, check Supabase “Redirect URLs”.</span>
  </div>
</footer>

<script type="module">
  // ======= CONFIG =======
  /* === CONFIG: UPDATE THESE === */
const SUPABASE_URL = "https://vzcgdpedoyiqzgguitum.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ6Y2dkcGVkb3lpcXpnZ3VpdHVtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkxNDA1MjksImV4cCI6MjA3NDcxNjUyOX0.hHMkwcrROCQHGlYPdfbVYmPffVHUiE838GktgXaRAzI";
const STORAGE_BUCKET = "media"; // your Storage bucket
  // Redirect ALWAYS uses current origin (fixes “localhost” issue)
  const REDIRECT_URL = `${window.location.origin}${window.location.pathname}`;
  document.getElementById('redir').textContent = REDIRECT_URL;

  // ======= INIT =======
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
  const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
    auth: { autoRefreshToken: true, persistSession: true, detectSessionInUrl: true }
  });

  const $ = (id)=>document.getElementById(id);
  const tabs = document.querySelectorAll(".tab");
  const panes = { study: $("study"), editor: $("editor"), admin: $("admin") };
  let session = null, profile = null;

  // ======= UI NAV =======
  tabs.forEach(t=>{
    t.onclick = ()=>{
      tabs.forEach(x=>x.classList.remove("active"));
      t.classList.add("active");
      Object.values(panes).forEach(p=>p.classList.add("hidden"));
      panes[t.dataset.tab].classList.remove("hidden");
    };
  });

  // ======= AUTH =======
  $("sendLink").onclick = async ()=>{
    const email = $("email").value.trim();
    if(!email) return alert("Enter email");
    const { error } = await sb.auth.signInWithOtp({ email, options:{ emailRedirectTo: REDIRECT_URL }});
    if(error) alert(error.message); else alert("Magic link sent. Please check your email.");
  };
  $("logout").onclick = async ()=>{
    await sb.auth.signOut();
    location.reload();
  };

  sb.auth.onAuthStateChange(async (_event, sess)=>{
    session = sess;
    updateAuthStatus();
    if(session?.user) {
      await ensureProfile(session.user);
      await loadChapters();
      await loadDeck();
      $("logout").classList.remove("hidden");
    }
  });

  async function ensureProfile(user){
    const { data } = await sb.from("profiles").select("*").eq("id", user.id).maybeSingle();
    profile = data || { role:"user", email:user.email };
    $("rolePill").textContent = profile.role || "user";
    $("userPill").textContent = user.email || user.id;

    // Gate Editor/Admin
    panes.editor.classList.toggle("hidden", !["editor","admin"].includes(profile.role));
    panes.admin.classList.toggle("hidden", profile.role!=="admin");
    document.querySelector('.tab[data-tab="editor"]').classList.toggle("hidden", !["editor","admin"].includes(profile.role));
    document.querySelector('.tab[data-tab="admin"]').classList.toggle("hidden", profile.role!=="admin");

    if(profile.role==="admin") loadUsers();
  }

  function updateAuthStatus(){
    const el = $("authStatus");
    if(!session?.user){ el.innerHTML = `Not signed in`; return; }
    const u = session.user;
    el.innerHTML = `Signed in as <strong>${u.email || u.id}</strong>`;
  }

  // ======= STUDY DECK =======
  let allCards = [];
  let gradesMap = new Map(); // card_id -> {grade, updated_at}

  $("chapterFilter").onchange = loadDeck;
  $("search").oninput = debounce(loadDeck, 300);

  async function loadChapters(){
    const { data } = await sb.from("cards").select("chapter").neq("status","archived");
    const chapters = Array.from(new Set((data||[]).map(x=>x.chapter))).sort();
    const sel = $("chapterFilter");
    sel.innerHTML = `<option value="">All chapters</option>` + chapters.map(c=>`<option>${c||"Unfiled"}</option>`).join("");
  }

  async function loadDeck(){
    const ch = $("chapterFilter").value;
    const q = $("search").value.trim();
    let query = sb.from("cards").select("id,front,back,chapter,tags,topics,status,visibility,meta").neq("status","archived").order("id",{ascending:true});
    if(ch) query = query.eq("chapter", ch);
    if(q) query = query.ilike("front", `%${q}%`);

    const { data:cards, error } = await query.limit(5000);
    if(error){ alert("Load cards error: "+error.message); return; }
    allCards = cards || [];
    await loadGrades();
    renderDeck();
  }

  async function loadGrades(){
    if(!session?.user){ gradesMap.clear(); return; }
    const { data } = await sb.from("card_grades").select("card_id, grade, updated_at").eq("user_id", session.user.id).limit(10000);
    gradesMap = new Map((data||[]).map(r=>[r.card_id, r]));
  }

  function renderDeck(){
    const container = $("deck");
    container.innerHTML = "";
    if(allCards.length===0){ container.innerHTML = `<p class="muted">No cards.</p>`; return; }

    allCards.forEach(card=>{
      const row = document.createElement("div");
      row.className = "card";
      const g = gradesMap.get(card.id)?.grade || null;
      const badge = g? `<span class="pill">Your grade: <strong>${g}</strong></span>` : `<span class="pill">Not graded</span>`;
      row.innerHTML = `
        <div class="q">${escapeHTML(card.front || "")}</div>
        <div class="muted">${badge} • Chapter: ${escapeHTML(card.chapter||"")}</div>
        <div class="controls">
          <button class="sec" data-act="show">Show answer</button>
          <button class="again" data-grade="again">Again</button>
          <button class="hard" data-grade="hard">Hard</button>
          <button class="good" data-grade="good">Good</button>
          <button class="sec" data-act="star">⭐</button>
        </div>
        <div class="a hidden">${escapeHTML(card.back || "")}</div>
      `;
      row.querySelector('[data-act="show"]').onclick = ()=> row.querySelector('.a').classList.toggle('hidden');
      row.querySelectorAll('[data-grade]').forEach(btn=>{
        btn.onclick = ()=> gradeCard(card.id, btn.dataset.grade, row);
      });
      row.querySelector('[data-act="star"]').onclick = ()=> starCard(card.id, row);
      container.appendChild(row);
    });
  }

  async function gradeCard(cardId, grade, row){
    if(!session?.user){ alert("Sign in to save grades."); return; }
    const payload = { user_id: session.user.id, card_id: cardId, grade, updated_at: new Date().toISOString() };
    // Optimistic update
    gradesMap.set(cardId, { card_id:cardId, grade, updated_at:payload.updated_at });
    row.querySelector('.muted').innerHTML = `<span class="pill">Your grade: <strong>${grade}</strong></span>`;
    try{
      await sb.from("card_grades").upsert(payload, { onConflict:"user_id,card_id" });
    }catch(e){
      console.error(e);
      alert("Failed to save grade.");
    }
  }

  async function starCard(cardId, row){
    // You can implement a stars table; here we just toggle a class visually.
    row.style.outline = row.style.outline ? "" : "2px solid #ffd54f";
  }

  // ======= EDITOR =======
  $("preview").onclick = ()=>{
    try{
      const j = JSON.parse($("jsonInput").value);
      const arr = (j.cards||[]).slice(0,10);
      $("previewOut").innerHTML = arr.map(c=>`<div class="card"><div class="q">${escapeHTML(c.front||"")}</div><div class="a">${escapeHTML(c.back||"")}</div><div class="muted">Chapter: ${escapeHTML(c.chapter||"")}</div></div>`).join("") || "<p class='muted'>No cards</p>";
    }catch(e){ alert("Invalid JSON: "+e.message); }
  };

  $("import").onclick = async ()=>{
    if(!["editor","admin"].includes(profile?.role)) return alert("Editor/Admin only.");
    let parsed;
    try{ parsed = JSON.parse($("jsonInput").value); }catch(e){ return alert("Invalid JSON: "+e.message); }
    const cards = parsed.cards||[];
    if(cards.length===0) return alert("No cards found.");
    // Normalize and upsert in batches
    const batchSize = 200;
    for(let i=0;i<cards.length;i+=batchSize){
      const chunk = cards.slice(i,i+batchSize).map(c=>({
        front: c.front, back: c.back, chapter: c.chapter||null,
        topics: c.topics||[], tags: c.tags||[], status: c.status||"published",
        visibility: c.visibility||"public", author_suspended: !!c.author_suspended,
        meta: c.meta||{}
      }));
      const { error } = await sb.from("cards").upsert(chunk);
      if(error){ console.error(error); return alert("Import error: "+error.message); }
    }
    alert("Import complete.");
    await loadChapters(); await loadDeck();
  };

  // ======= ADMIN =======
  async function loadUsers(){
    const { data, error } = await sb.from("profiles").select("email, display_name, role").order("email",{ascending:true});
    if(error){ $("users").innerHTML = `<div class='danger'>${error.message}</div>`; return;}
    $("users").innerHTML = (data||[]).map(u=>`<div class="card"><div><b>${escapeHTML(u.email||"")}</b></div><div class="muted">${escapeHTML(u.display_name||"")}</div><div>Role: <b>${escapeHTML(u.role||"user")}</b></div></div>`).join("");
  }

  // ======= HELPERS =======
  function escapeHTML(s){ return (s||"").replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
  function debounce(fn, ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }

  // Boot: ensure we render if already logged in
  (async ()=>{
    const { data:{ session:s } } = await sb.auth.getSession();
    session = s; updateAuthStatus();
    if(session?.user){ await ensureProfile(session.user); await loadChapters(); await loadDeck(); $("logout").classList.remove("hidden"); }
  })();
</script>
</body>
</html>
