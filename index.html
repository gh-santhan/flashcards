<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Flashcards</title>
<link rel="stylesheet" href="styles.css">
</head>
<body>
<header>
  <div class="wrap topbar">
    <h1>Flashcards</h1>
    <div class="row">
      <button id="btnLogin" class="ghost">Log in</button>
      <span id="whoami" class="small"></span>
      <button id="btnLogout" class="ghost" style="display:none">Log out</button>
    </div>
  </div>
  <div class="wrap tabs">
    <div class="tab on" data-tab="study">Study</div>
    <div class="tab" data-tab="editor">Editor</div>
    <div class="tab" data-tab="admin">Admin</div>
  </div>
</header>

<main class="wrap">
  <!-- STUDY -->
  <section id="tab-study">
    <details id="filters" class="filters" open>
      <summary>Filters & Tools</summary>
      <div class="row">
        <label>Chapter <select id="selChapter"></select></label>
        <label>Topic <select id="selTopic"></select></label>
        <button id="btnMix" class="ghost">Mix All</button>
        <button id="btnSearch" class="ghost">Search</button>
      </div>
      <div class="chips" id="diffChips">
        <span class="chip" data-diff="again">Again <span class="count" id="cnt-again">0</span></span>
        <span class="chip" data-diff="hard">Hard <span class="count" id="cnt-hard">0</span></span>
        <span class="chip" data-diff="good">Good <span class="count" id="cnt-good">0</span></span>
        <span class="chip" data-diff="easy">Easy <span class="count" id="cnt-easy">0</span></span>
        <span class="chip" data-diff="ungraded">Ungraded <span class="count" id="cnt-ungraded">0</span></span>
        <span class="chip" id="chip-star">‚òÖ Starred <span class="count" id="cnt-star">0</span></span>
      </div>
    </details>

    <section class="card">
      <div class="meta">
        <span id="metaChap" class="badge">‚Äî</span>
        <span id="metaTopics" class="badge">‚Äî</span>
        <span id="metaSection" class="badge">‚Äî</span>
        <span id="metaTags" class="badge">‚Äî</span>
        <span id="metaIndex" class="badge">0/0</span>
        <span id="metaResources" class="badge" style="display:none">Resources ‚Ä¢ <span id="resCount">0</span></span>
        <span id="metaEditor" style="margin-left:auto; display:none">
          <button id="btnEditCard" class="ghost">‚úé Edit</button>
          <button id="btnDeleteCard" class="danger">üóë Delete</button>
        </span>
      </div>

      <div class="q" id="q">‚Äî</div>

      <div class="actions">
        <button id="btnReveal" class="primary">Reveal</button>
        <button id="btnPrev" class="ghost">‚óÄ Prev</button>
        <button id="btnNext" class="ghost">Next ‚ñ∂</button>
        <button id="btnSuspend" class="ghost" title="Suspend/Unsuspend">‚è∏ Suspend</button>
        <button id="btnStar" class="ghost" title="Star/Unstar">‚òÜ Star</button>
      </div>

      <div id="ans" class="ans"></div>

      <div id="gradeRow" class="grade">
        <button class="g again" id="gAgain">Again</button>
        <button class="g hard" id="gHard">Hard</button>
        <button class="g good" id="gGood">Good</button>
        <button class="g easy" id="gEasy">Easy</button>
      </div>

      <div class="resources" id="resWrap" style="display:none">
        <div class="small">Resources</div>
        <div id="resList" class="res-list"></div>
      </div>
    </section>
  </section>

  <!-- EDITOR -->
  <section id="tab-editor" style="display:none">
    <div class="etabs">
      <div class="etab on" data-etab="cards">Cards</div>
      <div class="etab" data-etab="chapters">Chapters</div>
      <div class="etab" data-etab="topics">Topics</div>
      <div class="etab" data-etab="tags">Tags</div>
    </div>

    <!-- Cards page -->
    <section id="editor-cards">
      <p class="subtitle">Edit cards inline or open a card to modify front, back, tags, topics, notes/resources.</p>
      <table id="tblCards">
        <thead><tr><th>Front</th><th>Chapter</th><th>Topics</th><th>Tags</th><th>Actions</th></tr></thead>
        <tbody></tbody>
      </table>
      <div class="divider"></div>
      <button id="btnBulkDelete" class="danger">Bulk Delete‚Ä¶</button>
    </section>

    <!-- Chapters page -->
    <section id="editor-chapters" style="display:none">
      <p class="subtitle">Rename a chapter or delete it. Deleting a chapter will NOT delete cards ‚Äî their chapter will be set to <b>Uncategorised</b>.</p>
      <table id="tblChapters">
        <thead><tr><th>Chapter</th><th>Cards</th><th>Actions</th></tr></thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- Topics page -->
    <section id="editor-topics" style="display:none">
      <p class="subtitle">Rename or delete a topic. Deleting a topic removes links from cards; cards remain (may show as <b>No Topics</b>).</p>
      <table id="tblTopics">
        <thead><tr><th>Topic</th><th>Cards</th><th>Actions</th></tr></thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- Tags page -->
    <section id="editor-tags" style="display:none">
      <p class="subtitle">Rename or delete a tag. Deleting a tag removes tag links from cards; cards remain unchanged.</p>
      <table id="tblTags">
        <thead><tr><th>Tag</th><th>Cards</th><th>Actions</th></tr></thead>
        <tbody></tbody>
      </table>
    </section>
  </section>

  <!-- ADMIN -->
  <section id="tab-admin" style="display:none">
    <div class="divider"></div>
    <h3>Import JSON</h3>
    <div class="row">
      <input id="fileImport" type="file" accept=".json"/>
      <button id="btnImport" class="primary">Import</button>
    </div>

    <div class="divider"></div>
    <h3>Authoring Aids</h3>
    <div class="row">
      <button id="btnDownloadTemplate" class="ghost">Download JSON Template</button>
      <button id="btnOpenLLM" class="ghost">LLM Instructions</button>
    </div>
    <div class="small" style="margin-top:6px">
      The template matches the importer format. The LLM guide explains how to write <b>front</b>/<b>back</b>, split cards, expand acronyms, choose tags, and attach resources via <code>meta</code>.
    </div>
  </section>
</main>

<!-- Search Modal -->
<div id="searchModal" class="modal">
  <div class="shade"></div>
  <div class="panel">
    <div class="bar"><h3>Search</h3><button id="searchClose" class="ghost">‚úï</button></div>
    <div class="row" style="margin-top:8px">
      <input id="searchInput" type="text" placeholder="keyword or #tag" style="flex:1"/>
      <button id="searchGo" class="primary">Search</button>
    </div>
    <div class="small" style="margin-top:6px">Use <code>#tag</code> to filter by tag.</div>
    <div id="searchResults" style="margin-top:12px"></div>
    <div style="text-align:right;margin-top:10px">
      <button id="searchReviewAll" class="primary" disabled>Review All</button>
    </div>
  </div>
</div>

<!-- Edit Card Modal -->
<div id="editModal" class="modal">
  <div class="shade"></div>
  <div class="panel">
    <div class="bar"><h3>Edit Card</h3><button id="editClose" class="ghost">‚úï</button></div>
    <div class="row" style="margin-top:10px">
      <div style="flex:1">
        <label>Front<textarea id="edFront" rows="6" placeholder="Question‚Ä¶"></textarea></label>
      </div>
      <div style="flex:1">
        <label>Back<textarea id="edBack" rows="6" placeholder="Answer‚Ä¶"></textarea></label>
      </div>
    </div>
    <div class="row" style="margin-top:10px">
      <label>Chapter <select id="edChapter"></select></label>
      <label>Topics (‚åò/Ctrl for multi)
        <select id="edTopics" multiple size="5" style="min-width:220px"></select>
      </label>
      <label style="flex:1">Tags (comma-separated)
        <input id="edTags" type="text" placeholder="MCQ, Diagnosis, Protocol"/>
      </label>
    </div>
    <div style="margin-top:10px">
      <label>Additional Notes (optional)
        <textarea id="edNotes" rows="3" placeholder="Shown under Resources‚Ä¶"></textarea>
      </label>
    </div>
    <div style="margin-top:10px">
      <div class="bar"><h4 style="margin:0">Resources</h4></div>
      <div class="small">Add external links or upload images/PDFs.</div>
      <div class="row" style="margin-top:6px">
        <div>
          <label>New link ‚Äî Title<input id="edLinkTitle" type="text" placeholder="e.g., AASM guideline"/></label>
          <label>New link ‚Äî URL<input id="edLinkUrl" type="text" placeholder="https://‚Ä¶"/></label>
          <button id="btnAddLink" class="ghost">Add Link</button>
        </div>
        <div>
          <label>Upload file (image/PDF)
            <input id="edFile" type="file" accept="image/*,application/pdf"/>
          </label>
          <div class="small">Uploaded to Storage and added to this card.</div>
        </div>
      </div>
      <div id="edResList" class="res-list" style="margin-top:10px"></div>
    </div>
    <div style="text-align:right;margin-top:12px">
      <button id="btnSaveCard" class="primary">Save</button>
    </div>
  </div>
</div>

<!-- Bulk Delete Modal -->
<div id="bulkDeleteModal" class="modal">
  <div class="shade"></div>
  <div class="panel">
    <div class="bar"><h3>Bulk Delete Cards</h3><button id="bdClose" class="ghost">‚úï</button></div>
    <div class="row" style="margin-top:10px">
      <label>Mode
        <select id="bdMode"><option value="chapter">By Chapter</option><option value="topic">By Topic</option></select>
      </label>
      <label>Pick one
        <select id="bdPicker"></select>
      </label>
    </div>
    <div class="small" style="margin-top:8px">Selection preview: <b id="bdCount">0</b> card(s) will be deleted.</div>
    <div class="small" style="margin-top:4px;color:#fca5a5">Permanently deletes cards + joins (topics/tags/reviews). No undo.</div>
    <div style="margin-top:8px">Type <code>DELETE</code> to enable: <input id="bdConfirm" type="text" style="width:160px;margin-left:8px"></div>
    <div style="text-align:right;margin-top:10px"><button id="bdRun" class="danger" disabled>Delete Selected</button></div>
  </div>
</div>

<!-- LLM Instructions Modal -->
<div id="llmModal" class="modal">
  <div class="shade"></div>
  <div class="panel">
    <div class="bar"><h3>LLM Authoring Instructions</h3><button id="llmClose" class="ghost">‚úï</button></div>
    <div class="small" style="margin:6px 0 10px">Use this prompt to generate a valid JSON file you can import directly.</div>
    <textarea id="llmText" rows="18" style="width:100%;white-space:pre;overflow:auto"></textarea>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
      <button id="llmCopy" class="ghost">Copy</button>
      <button id="llmDownload" class="primary">Download .txt</button>
    </div>
  </div>
</div>

<!-- Supabase UMD + App modules -->
<script src="https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
<script type="module" src="/js/main.js"></script>
</body>
</html>
