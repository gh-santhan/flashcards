<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Flashcards</title>
<style>
:root{--bg:#0b0b0b;--fg:#f7f7f7;--muted:#a9a9a9;--line:#1c1c1c;--accent:#4f8cff;--chip:#141414;--chipOn:#1f2937;--danger:#ef4444}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--fg);font:15px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
a{color:#cde1ff}
header{border-bottom:1px solid var(--line);padding:10px 14px}
h1{margin:0;font-size:20px}
.wrap{max-width:980px;margin:0 auto;padding:12px}
.topbar{display:flex;align-items:center;justify-content:space-between;gap:8px}
.tabs{display:flex;gap:6px;align-items:center;flex-wrap:wrap;margin-top:8px}
.tab{background:#101010;border:1px solid var(--line);border-radius:10px;padding:6px 10px;cursor:pointer}
.tab.on{background:#182030}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
select,input,textarea{background:#0f0f0f;color:var(--fg);border:1px solid var(--line);border-radius:10px;padding:8px 10px}
textarea{width:100%}
button{background:#111;color:var(--fg);border:1px solid var(--line);border-radius:12px;padding:8px 12px;cursor:pointer}
button.primary{background:var(--accent);border-color:#6aa1ff;color:#fff}
button.ghost{background:#0f0f0f}
button.danger{background:#3a0f12;border-color:#7f1d1d}
.chips{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0}
.chip{border:1px solid var(--line);background:var(--chip);border-radius:999px;padding:6px 10px;font-size:13px;cursor:pointer}
.chip.on{background:var(--chipOn)}
.card{margin-top:12px;background:#0f0f0f;border:1px solid var(--line);border-radius:14px;padding:16px}
.meta{display:flex;gap:8px;flex-wrap:wrap;font-size:12px;color:var(--muted);margin-bottom:8px}
.badge{border:1px solid var(--line);border-radius:999px;padding:2px 8px;background:#121212}
.q{font-size:18px;margin:6px 0}
.ans{margin-top:10px;padding-top:10px;border-top:1px dashed #222;display:none}
.actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
.grade{display:none;gap:8px;flex-wrap:wrap;margin-top:10px}
.g{border-radius:999px;padding:10px 14px;border:1px solid #2a2a2a}
.g.again{background:#1f2937} .g.hard{background:#2a1f3a} .g.good{background:#1f3a2a} .g.easy{background:#193a33}
.divider{height:1px;background:var(--line);margin:16px 0}
.small{font-size:12px;color:var(--muted)}
table{width:100%;border-collapse:collapse}
th,td{border-bottom:1px solid #1a1a1a;padding:8px 6px;text-align:left;vertical-align:top}
th{color:#c0c0c0;font-weight:600}
.subtitle{font-size:14px;color:#c0c0c0;margin:0 0 6px}
/* resources */
.resources{margin-top:10px;border-top:1px dashed #222;padding-top:8px}
.res-list{display:flex;gap:8px;flex-wrap:wrap}
.res{border:1px solid var(--line);border-radius:10px;padding:6px 8px;background:#111;display:flex;gap:6px;align-items:center}
.thumb{width:52px;height:52px;object-fit:cover;border-radius:8px;border:1px solid #222}
/* modals */
.modal{display:none;position:fixed;inset:0;z-index:9999;align-items:center;justify-content:center}
.shade{position:absolute;inset:0;background:#000;opacity:.92}
.panel{position:relative;background:#0f0f0f;border:1px solid #1f2937;border-radius:14px;width:min(860px,94vw);max-height:92vh;overflow:auto;padding:16px}
.bar{display:flex;align-items:center;justify-content:space-between;gap:8px}
/* editor subtabs */
.etabs{display:flex;gap:8px;margin:8px 0 12px}
.etab{padding:6px 10px;border:1px solid var(--line);border-radius:8px;background:#101010;cursor:pointer}
.etab.on{background:#1a2233}
/* accordion */
.accordion{margin:10px 0;border:1px solid var(--line);border-radius:12px;background:#0f0f0f}
.accordion .head{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:10px 12px;cursor:pointer}
.accordion .body{display:none;padding:10px 12px;border-top:1px solid var(--line)}
.accordion.open .body{display:block}
@media (max-width:640px){.q{font-size:17px}}
</style>
</head>
<body>
<header>
  <div class="wrap topbar">
    <h1>Flashcards</h1>
    <div class="row">
      <button id="btnLogin" class="ghost">Log in</button>
      <span id="whoami" class="small"></span>
      <button id="btnLogout" class="ghost" style="display:none">Log out</button>
    </div>
  </div>
  <div class="wrap tabs">
    <div class="tab on" data-tab="study">Study</div>
    <div class="tab" data-tab="editor">Editor</div>
    <div class="tab" data-tab="admin">Admin</div>
  </div>
</header>

<main class="wrap">
  <!-- STUDY -->
  <section id="tab-study">
    <!-- Filters accordion -->
    <div id="filters" class="accordion">
      <div class="head" id="filtersHead">
        <div><b>Filters</b> <span class="small" id="filtersSummary">All chapters ‚Ä¢ All topics ‚Ä¢ All difficulties</span></div>
        <button class="ghost" id="filtersToggle">‚ñº</button>
      </div>
      <div class="body" id="filtersBody">
        <div class="row">
          <label>Chapter <select id="selChapter"></select></label>
          <label>Topic <select id="selTopic"></select></label>
          <button id="btnMix" class="ghost">Mix All</button>
          <button id="btnSearch" class="ghost">Search</button>
        </div>
        <div class="chips" id="diffChips">
          <span class="chip" data-diff="again">Again <span class="count" id="cnt-again">0</span></span>
          <span class="chip" data-diff="hard">Hard <span class="count" id="cnt-hard">0</span></span>
          <span class="chip" data-diff="good">Good <span class="count" id="cnt-good">0</span></span>
          <span class="chip" data-diff="easy">Easy <span class="count" id="cnt-easy">0</span></span>
          <span class="chip" data-diff="ungraded">Ungraded <span class="count" id="cnt-ungraded">0</span></span>
          <span class="chip" id="chip-star">‚òÖ Starred <span class="count" id="cnt-star">0</span></span>
        </div>
      </div>
    </div>

    <section class="card">
      <div class="meta">
        <span id="metaChap" class="badge">‚Äî</span>
        <span id="metaTopics" class="badge">‚Äî</span>
        <span id="metaSection" class="badge">‚Äî</span>
        <span id="metaTags" class="badge">‚Äî</span>
        <span id="metaIndex" class="badge">0/0</span>
        <span id="metaResources" class="badge" style="display:none">Resources ‚Ä¢ <span id="resCount">0</span></span>
        <span id="metaEditor" style="margin-left:auto; display:none">
          <button id="btnEditCard" class="ghost">‚úé Edit</button>
          <button id="btnDeleteCard" class="danger">üóë Delete</button>
        </span>
      </div>

      <div class="q" id="q">‚Äî</div>

      <div class="actions">
        <button id="btnReveal" class="primary">Reveal</button>
        <button id="btnPrev" class="ghost">‚óÄ Prev</button>
        <button id="btnNext" class="ghost">Next ‚ñ∂</button>
        <button id="btnSuspend" class="ghost" title="Suspend/Unsuspend">‚è∏ Suspend</button>
        <button id="btnStar" class="ghost" title="Star/Unstar">‚òÜ Star</button>
      </div>

      <div id="ans" class="ans"></div>

      <div id="gradeRow" class="grade">
        <button class="g again" id="gAgain">Again</button>
        <button class="g hard" id="gHard">Hard</button>
        <button class="g good" id="gGood">Good</button>
        <button class="g easy" id="gEasy">Easy</button>
      </div>

      <div class="resources" id="resWrap" style="display:none">
        <div class="small">Resources</div>
        <div id="resList" class="res-list"></div>
      </div>
    </section>
  </section>

  <!-- EDITOR -->
  <section id="tab-editor" style="display:none">
    <div class="etabs">
      <div class="etab on" data-etab="cards">Cards</div>
      <div class="etab" data-etab="chapters">Chapters</div>
      <div class="etab" data-etab="topics">Topics</div>
      <div class="etab" data-etab="tags">Tags</div>
    </div>

    <!-- Cards page -->
    <section id="editor-cards">
      <p class="subtitle">Edit cards inline or open a card to modify front, back, tags, topics, notes/resources.</p>
      <table id="tblCards">
        <thead><tr>
          <th>Front</th><th>Chapter</th><th>Topics</th><th>Tags</th><th>Actions</th>
        </tr></thead>
        <tbody></tbody>
      </table>
      <div class="divider"></div>
      <button id="btnBulkDelete" class="danger">Bulk Delete‚Ä¶</button>
    </section>

    <!-- Chapters page -->
    <section id="editor-chapters" style="display:none">
      <p class="subtitle">Rename a chapter or delete it. Deleting a chapter will NOT delete cards ‚Äî their chapter will be set to <b>Uncategorised</b>.</p>
      <table id="tblChapters">
        <thead><tr><th>Chapter</th><th>Cards</th><th>Actions</th></tr></thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- Topics page -->
    <section id="editor-topics" style="display:none">
      <p class="subtitle">Rename or delete a topic. Deleting a topic removes links from cards; cards remain (may show as <b>No Topics</b>).</p>
      <table id="tblTopics">
        <thead><tr><th>Topic</th><th>Cards</th><th>Actions</th></tr></thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- Tags page -->
    <section id="editor-tags" style="display:none">
      <p class="subtitle">Rename or delete a tag. Deleting a tag removes tag links from cards; cards remain unchanged.</p>
      <table id="tblTags">
        <thead><tr><th>Tag</th><th>Cards</th><th>Actions</th></tr></thead>
        <tbody></tbody>
      </table>
    </section>
  </section>

  <!-- ADMIN -->
  <section id="tab-admin" style="display:none">
    <div class="divider"></div>
    <h3>Import JSON</h3>
    <div class="row">
      <input id="fileImport" type="file" accept=".json"/>
      <button id="btnImport" class="primary">Import</button>
    </div>

    <div class="divider"></div>
    <h3>Authoring Aids</h3>
    <div class="row">
      <button id="btnDownloadTemplate" class="ghost">Download JSON Template</button>
      <button id="btnOpenLLM" class="ghost">LLM Instructions</button>
    </div>
    <div class="small" style="margin-top:6px">
      The template matches the importer format. The LLM guide explains how to write <b>front</b>/<b>back</b>, split cards, expand acronyms, choose tags, and attach resources via <code>meta</code>.
    </div>
  </section>
</main>

<!-- Search Modal -->
<div id="searchModal" class="modal">
  <div class="shade"></div>
  <div class="panel">
    <div class="bar"><h3>Search</h3><button id="searchClose" class="ghost">‚úï</button></div>
    <div class="row" style="margin-top:8px">
      <input id="searchInput" type="text" placeholder="keyword or #tag" style="flex:1"/>
      <button id="searchGo" class="primary">Search</button>
    </div>
    <div class="small" style="margin-top:6px">Use <code>#tag</code> to filter by tag.</div>
    <div id="searchResults" style="margin-top:12px"></div>
    <div style="text-align:right;margin-top:10px">
      <button id="searchReviewAll" class="primary" disabled>Review All</button>
    </div>
  </div>
</div>

<!-- Edit Card Modal -->
<div id="editModal" class="modal">
  <div class="shade"></div>
  <div class="panel">
    <div class="bar"><h3>Edit Card</h3><button id="editClose" class="ghost">‚úï</button></div>
    <div class="row" style="margin-top:10px">
      <div style="flex:1">
        <label>Front<textarea id="edFront" rows="6" placeholder="Question‚Ä¶"></textarea></label>
      </div>
      <div style="flex:1">
        <label>Back<textarea id="edBack" rows="6" placeholder="Answer‚Ä¶"></textarea></label>
      </div>
    </div>
    <div class="row" style="margin-top:10px">
      <label>Chapter <select id="edChapter"></select></label>
      <label>Topics (‚åò/Ctrl for multi)
        <select id="edTopics" multiple size="5" style="min-width:220px"></select>
      </label>
      <label style="flex:1">Tags (comma-separated)
        <input id="edTags" type="text" placeholder="MCQ, Diagnosis, Protocol"/>
      </label>
    </div>
    <div style="margin-top:10px">
      <label>Additional Notes (optional)
        <textarea id="edNotes" rows="3" placeholder="Shown under Resources‚Ä¶"></textarea>
      </label>
    </div>
    <div style="margin-top:10px">
      <div class="bar"><h4 style="margin:0">Resources</h4></div>
      <div class="small">Add external links or upload images/PDFs.</div>
      <div class="row" style="margin-top:6px">
        <div>
          <label>New link ‚Äî Title<input id="edLinkTitle" type="text" placeholder="e.g., AASM guideline"/></label>
          <label>New link ‚Äî URL<input id="edLinkUrl" type="text" placeholder="https://‚Ä¶"/></label>
          <button id="btnAddLink" class="ghost">Add Link</button>
        </div>
        <div>
          <label>Upload file (image/PDF)
            <input id="edFile" type="file" accept="image/*,application/pdf"/>
          </label>
          <div class="small">Uploaded to Storage and added to this card.</div>
        </div>
      </div>
      <div id="edResList" class="res-list" style="margin-top:10px"></div>
    </div>
    <div style="text-align:right;margin-top:12px">
      <button id="btnSaveCard" class="primary">Save</button>
    </div>
  </div>
</div>

<!-- Bulk Delete Modal -->
<div id="bulkDeleteModal" class="modal">
  <div class="shade"></div>
  <div class="panel">
    <div class="bar"><h3>Bulk Delete Cards</h3><button id="bdClose" class="ghost">‚úï</button></div>
    <div class="row" style="margin-top:10px">
      <label>Mode
        <select id="bdMode"><option value="chapter">By Chapter</option><option value="topic">By Topic</option></select>
      </label>
      <label>Pick one
        <select id="bdPicker"></select>
      </label>
    </div>
    <div class="small" style="margin-top:8px">Selection preview: <b id="bdCount">0</b> card(s) will be deleted.</div>
    <div class="small" style="margin-top:4px;color:#fca5a5">Permanently deletes cards + joins (topics/tags/reviews). No undo.</div>
    <div style="margin-top:8px">Type <code>DELETE</code> to enable: <input id="bdConfirm" type="text" style="width:160px;margin-left:8px"></div>
    <div style="text-align:right;margin-top:10px"><button id="bdRun" class="danger" disabled>Delete Selected</button></div>
  </div>
</div>

<!-- LLM Instructions Modal -->
<div id="llmModal" class="modal">
  <div class="shade"></div>
  <div class="panel">
    <div class="bar"><h3>LLM Authoring Instructions</h3><button id="llmClose" class="ghost">‚úï</button></div>
    <div class="small" style="margin:6px 0 10px">Use this prompt to generate a valid JSON file you can import directly.</div>
    <textarea id="llmText" rows="18" style="width:100%;white-space:pre;overflow:auto"></textarea>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
      <button id="llmCopy" class="ghost">Copy</button>
      <button id="llmDownload" class="primary">Download .txt</button>
    </div>
  </div>
</div>

<script src="https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
<script>
/* === CONFIG: UPDATE THESE === */
const SUPABASE_URL = "https://vzcgdpedoyiqzgguitum.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ6Y2dkcGVkb3lpcXpnZ3VpdHVtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkxNDA1MjksImV4cCI6MjA3NDcxNjUyOX0.hHMkwcrROCQHGlYPdfbVYmPffVHUiE838GktgXaRAzI";
const STORAGE_BUCKET = "media";

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* State */
let session=null,user=null;
let chapters=[], topics=[], tags=[], cards=[];
let userGrades=new Map(); // card_id -> grade
let scope={chapter:null,topic:null,mix:false,diff:null,starred:false};
let order=[], idx=0, currentCard=null;
let searchResults=[];

/* Utils */
const $ = id=>document.getElementById(id);
const escapeHTML = (s='')=>s.replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));

/* Tabs */
document.querySelectorAll('.tab').forEach(t=>{
  t.onclick=()=>{
    document.querySelectorAll('.tab').forEach(x=>x.classList.remove('on'));
    t.classList.add('on');
    const which=t.dataset.tab;
    ['study','editor','admin'].forEach(k=>{ $('tab-'+k).style.display = (k===which)?'block':'none'; });
  };
});

/* Editor subtabs */
document.querySelectorAll('.etab').forEach(t=>{
  t.onclick=()=>{
    document.querySelectorAll('.etab').forEach(x=>x.classList.remove('on'));
    t.classList.add('on');
    const which=t.dataset.etab;
    ['cards','chapters','topics','tags'].forEach(k=>{ $('editor-'+k).style.display = (k===which)?'block':'none'; });
  };
});

/* Auth */
async function initAuth(){
  const { data:{ session:s } } = await supabase.auth.getSession();
  session=s; user=s?.user||null; syncAuthUI();
  supabase.auth.onAuthStateChange((evt,sess)=>{session=sess;user=sess?.user||null;syncAuthUI(); if(user){loadAll();}});
}
function siteRedirect(){ return location.origin + location.pathname; }
function syncAuthUI(){
  $('btnLogin').style.display = user?'none':'inline-block';
  $('btnLogout').style.display = user?'inline-block':'none';
  $('whoami').textContent = user?(user.email||''):'';
  $('metaEditor').style.display = user?'inline-block':'none';
}
$('btnLogin').onclick=async()=>{
  const email=prompt('Enter email for magic link:'); if(!email) return;
  const { error } = await supabase.auth.signInWithOtp({ email, options:{ emailRedirectTo: siteRedirect() }});
  if(error) alert(error.message); else alert('Magic link sent.');
};
$('btnLogout').onclick=async()=>{ await supabase.auth.signOut(); location.reload(); };

/* Loads */
async function loadTaxonomy(){
  const { data:ch }=await supabase.from('chapters').select('*').order('title');
  const { data:tp }=await supabase.from('topics').select('*').order('title');
  const { data:tg }=await supabase.from('tags').select('*').order('name');
  chapters=ch||[]; topics=tp||[]; tags=tg||[];
}
async function loadCards(){
  const { data: cs } = await supabase.from('cards')
    .select(`*, card_topics(topic_id, topics(id,title)), card_tags(tag_id, tags(id,name))`)
    .order('created_at',{ascending:true});
  cards = (cs||[]).map(c=>{
    c.card_topics=(c.card_topics||[]).map(ct=>({topic_id:ct.topic_id,title:ct.topics?.title}));
    c.card_tags=(c.card_tags||[]).map(ct=>({tag_id:ct.tag_id,name:ct.tags?.name}));
    c.meta=c.meta||{};
    c.author_suspended = (typeof c.author_suspended==='boolean')? c.author_suspended : (c.is_author_suspended||false);
    return c;
  });
}
async function loadUserGrades(){
  userGrades.clear();
  if(!user) return;
  const { data } = await supabase.from('card_grades').select('card_id, grade').eq('user_id', user.id);
  (data||[]).forEach(r=>userGrades.set(r.card_id, r.grade));
  // attach into cards for UI
  cards.forEach(c=>{ c.user_grade = userGrades.get(c.id) || 'ungraded'; });
}

/* Pickers & counts */
function buildScopePickers(){
  const selC=$('selChapter'), selT=$('selTopic');
  const vis=cards.filter(visibleToLearner);
  const byChap=new Map(), byTopic=new Map();
  let uncat=0, noTopic=0;

  vis.forEach(c=>{
    if(!c.chapter_id) uncat++;
    else byChap.set(c.chapter_id,(byChap.get(c.chapter_id)||0)+1);
    if((c.card_topics||[]).length===0) noTopic++;
    (c.card_topics||[]).forEach(ct=>byTopic.set(ct.topic_id,(byTopic.get(ct.topic_id)||0)+1));
  });

  selC.innerHTML = `<option value="">All Chapters (${vis.length})</option>` +
    chapters.map(ch=>`<option value="${ch.id}">${escapeHTML(ch.title)} (${byChap.get(ch.id)||0})</option>`).join('') +
    `<option value="__null__">(Uncategorised) (${uncat})</option>`;

  const chapVal = selC.value || scope.chapter;
  let topicOpts = topics;
  if(chapVal && chapVal!=="__null__"){
    const tset=new Set();
    vis.filter(c=>c.chapter_id===chapVal).forEach(c=>(c.card_topics||[]).forEach(ct=>tset.add(ct.topic_id)));
    topicOpts = topics.filter(t=>tset.has(t.id));
    noTopic = vis.filter(c=>c.chapter_id===chapVal && (c.card_topics||[]).length===0).length;
  }

  selT.innerHTML = `<option value="">All Topics</option>` +
    topicOpts.map(tp=>`<option value="${tp.id}">${escapeHTML(tp.title)} (${byTopic.get(tp.id)||0})</option>`).join('') +
    `<option value="__none__">(No Topics) (${noTopic})</option>`;

  selC.onchange=()=>{ scope.chapter=selC.value||null; scope.mix=false; rebuildOrder(); renderCounts(); renderCard(); buildScopePickers(); updateFiltersSummary(); };
  selT.onchange=()=>{ scope.topic=selT.value||null; scope.mix=false; rebuildOrder(); renderCounts(); renderCard(); updateFiltersSummary(); };
  $('btnMix').onclick=()=>{ scope={chapter:null,topic:null,mix:true,diff:null,starred:false}; rebuildOrder(); renderCounts(); renderCard(); buildScopePickers(); updateFiltersSummary(); };
  updateFiltersSummary();
}
function renderCounts(){
  const pool=cards.filter(c=>visibleToLearner(c) && chapMatch(c) && topicMatch(c));
  const counts={again:0,hard:0,good:0,easy:0,ungraded:0,star:0};
  pool.forEach(c=>{ const g=c.user_grade||'ungraded'; counts[g]++; if(c.user_starred) counts.star++; });
  $('cnt-again').textContent=counts.again; $('cnt-hard').textContent=counts.hard; $('cnt-good').textContent=counts.good;
  $('cnt-easy').textContent=counts.easy; $('cnt-ungraded').textContent=counts.ungraded; $('cnt-star').textContent=counts.star;
}
function visibleToLearner(c){ const pub=(c.status==='published' && c.visibility==='public' && !c.author_suspended); return pub || !!user; }
function chapMatch(c){ if(!scope.chapter) return true; if(scope.chapter==='__null__') return !c.chapter_id; return c.chapter_id===scope.chapter; }
function topicMatch(c){
  if(!scope.topic) return true;
  if(scope.topic==='__none__') return (c.card_topics||[]).length===0;
  return (c.card_topics||[]).some(ct=>ct.topic_id===scope.topic);
}
function bindDiffChips(){
  [...$('diffChips').children].forEach(ch=>{
    ch.onclick=()=>{
      const d=ch.dataset.diff;
      if(d){ scope.diff=(scope.diff===d?null:d); }
      if(ch.id==='chip-star'){ scope.starred=!scope.starred; }
      [...$('diffChips').children].forEach(x=>x.classList.remove('on'));
      if(scope.diff){ $('diffChips').querySelector(`.chip[data-diff="${scope.diff}"]`).classList.add('on'); }
      if(scope.starred){ $('chip-star').classList.add('on'); }
      rebuildOrder(); renderCounts(); renderCard(); updateFiltersSummary();
    };
  });
}

/* Accordion */
$('filtersToggle').onclick=()=>{ $('filters').classList.toggle('open'); };
$('filtersHead').onclick=(e)=>{ if(e.target.id!=='filtersToggle') $('filters').classList.toggle('open'); };
function updateFiltersSummary(){
  const chapTxt = scope.chapter ? (scope.chapter==='__null__' ? 'Uncategorised' : (chapters.find(c=>c.id===scope.chapter)?.title||'Chapter')) : 'All chapters';
  let topicTxt = 'All topics';
  if(scope.topic){ topicTxt = scope.topic==='__none__' ? 'No topics' : (topics.find(t=>t.id===scope.topic)?.title||'Topic'); }
  let diffTxt = scope.diff ? scope.diff : 'All difficulties';
  $('filtersSummary').textContent = `${chapTxt} ‚Ä¢ ${topicTxt} ‚Ä¢ ${diffTxt}`;
}

/* Filtering & render */
function inScope(c){
  if(!visibleToLearner(c)) return false;
  if(!chapMatch(c)) return false;
  if(!topicMatch(c)) return false;
  if(scope.diff){ const g=c.user_grade||'ungraded'; if(g!==scope.diff) return false; }
  if(scope.starred && !c.user_starred) return false;
  return true;
}
function rebuildOrder(){
  const pool=cards.filter(inScope);
  order=pool.map((c,i)=>i); window._pool=pool; idx=0;
  $('metaIndex').textContent=`${order.length?1:0}/${order.length}`;
}
function renderCard(){
  const pool=window._pool||[];
  $('metaIndex').textContent=`${order.length?(idx+1):0}/${order.length}`;
  if(!order.length){ $('q').innerHTML='No cards match.'; $('ans').style.display='none'; $('gradeRow').style.display='none'; $('resWrap').style.display='none'; return; }
  const c=pool[order[idx]]; currentCard=c;
  const chap=chapters.find(x=>x.id===c.chapter_id)?.title||'(Uncategorised)';
  const tps=(c.card_topics||[]).map(x=>x.title).filter(Boolean);

  $('metaChap').textContent=chap;
  $('metaTopics').textContent=tps.length? tps.join(' ‚Ä¢ '):'(No Topics)';
  $('metaSection').textContent=c.meta?.Section||'‚Äî';
  $('metaTags').textContent=(c.card_tags||[]).map(x=>x.name).filter(Boolean).join(', ')||'‚Äî';

  $('q').innerHTML=c.front||'‚Äî';
  $('ans').innerHTML=c.back||'';
  $('ans').style.display='none';
  $('gradeRow').style.display='none';

  const res=(c.meta?.resources)||[]; $('resCount').textContent=res.length+(c.meta?.notes?1:0);
  $('metaResources').style.display=(res.length||c.meta?.notes)?'inline-block':'none';
  renderResources(c);

  $('btnDeleteCard').style.display = user?'inline-block':'none';
  $('btnEditCard').style.display = user?'inline-block':'none';

  $('btnStar').textContent = c.user_starred?'‚òÖ Unstar':'‚òÜ Star';
  $('btnSuspend').textContent = c.author_suspended?'‚ñ∂ Unsuspend':'‚è∏ Suspend';
}
function renderResources(c){
  const list=$('resList'); list.innerHTML='';
  if(c.meta?.notes){ const n=document.createElement('div'); n.className='res'; n.innerHTML=`<span>üìù</span><span>${escapeHTML(String(c.meta.notes).slice(0,180))}${String(c.meta.notes).length>180?'‚Ä¶':''}</span>`; list.appendChild(n); }
  (c.meta?.resources||[]).forEach(r=>{
    const d=document.createElement('div'); d.className='res';
    if(r.type==='image'){ d.innerHTML=`<img class="thumb" src="${r.url}" alt="image"/><a target="_blank" href="${r.url}">${escapeHTML(r.title||'Image')}</a>`; }
    else if(r.type==='pdf'){ d.innerHTML=`<span>üìÑ</span><a target="_blank" href="${r.url}">${escapeHTML(r.title||'PDF')}</a>`; }
    else { d.innerHTML=`<span>üîó</span><a target="_blank" href="${r.url}">${escapeHTML(r.title||r.url)}</a>`; }
    list.appendChild(d);
  });
}

/* Study actions + persistent grade */
$('btnPrev').onclick=()=>{ if(order.length){ idx=(idx-1+order.length)%order.length; renderCard(); } };
$('btnNext').onclick=()=>{ if(order.length){ idx=(idx+1)%order.length; renderCard(); } };
$('btnReveal').onclick=()=>{ $('ans').style.display='block'; $('gradeRow').style.display='flex'; };
$('gAgain').onclick=()=>grade('again'); $('gHard').onclick=()=>grade('hard'); $('gGood').onclick=()=>grade('good'); $('gEasy').onclick=()=>grade('easy');

async function grade(level){
  if(!currentCard) return;
  currentCard.user_grade=level; // optimistic
  userGrades.set(currentCard.id, level);
  renderCounts();
  if(user){ // persist
    await supabase.from('card_grades').upsert({
      user_id: user.id,
      card_id: currentCard.id,
      grade: level
    }, { onConflict: 'user_id,card_id' });
  }
  $('btnNext').click();
}

$('btnStar').onclick=()=>{ if(!currentCard) return; currentCard.user_starred=!currentCard.user_starred; renderCounts(); renderCard(); };
$('btnSuspend').onclick=async()=>{
  if(!user||!currentCard) return;
  const newVal=!currentCard.author_suspended;
  const { error } = await supabase.from('cards').update({ author_suspended:newVal }).eq('id', currentCard.id);
  if(error){ alert(error.message); return; }
  currentCard.author_suspended=newVal; renderCard(); renderCounts();
};

/* Search */
$('btnSearch').onclick=()=>{$('searchModal').style.display='flex'; $('searchInput').focus();};
$('searchClose').onclick=()=>{$('searchModal').style.display='none';};
$('searchGo').onclick=runSearch;
$('searchInput').addEventListener('keydown',e=>{ if(e.key==='Enter') runSearch(); });
function runSearch(){
  const q=$('searchInput').value.trim();
  if(!q){ $('searchResults').innerHTML=''; $('searchReviewAll').disabled=true; return; }
  let res=cards.filter(visibleToLearner);
  if(q.startsWith('#')){ const tag=q.slice(1).toLowerCase(); res=res.filter(c=>(c.card_tags||[]).some(t=>(t.name||'').toLowerCase().includes(tag))); }
  else{ const s=q.toLowerCase(); res=res.filter(c=>(c.front||'').toLowerCase().includes(s)||(c.back||'').toLowerCase().includes(s)||(c.meta?.Section||'').toLowerCase().includes(s)); }
  searchResults=res.map(c=>c.id);
  $('searchResults').innerHTML = res.map(c=>`
  <div style="padding:8px;border:1px solid #1b1b1b;border-radius:10px;margin:6px 0;background:#0b0b0b">
    <div class="small">${escapeHTML(chapters.find(x=>x.id===c.chapter_id)?.title||'(Uncategorised)')} ‚Ä¢ ${(c.card_topics||[]).map(t=>escapeHTML(t.title)).join(', ')||'(No Topics)'}</div>
    <div style="margin:6px 0">${c.front}</div>
    <div class="small">${(c.card_tags||[]).map(t=>escapeHTML(t.name)).join(', ')}</div>
  </div>`).join('') || '<div class="small">No matches.</div>';
  $('searchReviewAll').disabled=!res.length;
}
$('searchReviewAll').onclick=()=>{
  if(!searchResults.length) return;
  const idset=new Set(searchResults); const pool=cards.filter(c=>idset.has(c.id)&&visibleToLearner(c));
  window._pool=pool; order=pool.map((c,i)=>i); idx=0; $('searchModal').style.display='none';
  scope={chapter:null,topic:null,mix:false,diff:null,starred:false}; renderCounts(); buildScopePickers(); renderCard(); updateFiltersSummary();
};

/* Editor: Cards table & actions (unchanged core) */
function renderCardTable(){
  const tb=$('tblCards').querySelector('tbody');
  tb.innerHTML = cards.slice(0,1000).map(c=>{
    const chap=chapters.find(x=>x.id===c.chapter_id)?.title||'(Uncategorised)';
    const tps=(c.card_topics||[]).map(x=>x.title).filter(Boolean).join(', ');
    const tgs=(c.card_tags||[]).map(x=>x.name).filter(Boolean).join(', ');
    return `<tr>
      <td class="small">${c.front}</td>
      <td class="small">${escapeHTML(chap)}</td>
      <td class="small">${escapeHTML(tps||'(No Topics)')}</td>
      <td class="small">${escapeHTML(tgs||'‚Äî')}</td>
      <td class="small"><button class="ghost" onclick="openEdit('${c.id}')">‚úé</button> <button class="danger" onclick="deleteCardById('${c.id}')">üóë</button></td>
    </tr>`;
  }).join('');
}

async function deleteCardById(cardId){
  if(!confirm('Delete this card permanently?')) return;
  await supabase.from('card_topics').delete().eq('card_id', cardId);
  await supabase.from('card_tags').delete().eq('card_id', cardId);
  try{ await supabase.from('reviews').delete().eq('card_id', cardId);}catch(e){}
  await supabase.from('card_grades').delete().eq('card_id', cardId);
  const { error } = await supabase.from('cards').delete().eq('id', cardId);
  if(error){ alert(error.message); return; }
  await loadCards(); await loadUserGrades(); rebuildOrder(); renderCounts(); renderCard(); buildEditorTables(); buildScopePickers(); updateFiltersSummary();
}

/* Editor tables */
function buildEditorTables(){
  renderCardTable();

  const tc=$('tblChapters').querySelector('tbody');
  const byChap=new Map(); cards.forEach(c=>{ byChap.set(c.chapter_id,(byChap.get(c.chapter_id)||0)+1); });
  tc.innerHTML = chapters.map(ch=>{
    const n=byChap.get(ch.id)||0;
    return `<tr>
      <td>${escapeHTML(ch.title)}</td>
      <td>${n}</td>
      <td>
        <button class="ghost" onclick="renameChapter('${ch.id}','${escapeHTML(ch.title)}')">‚úé Edit</button>
        <button class="danger" onclick="deleteChapter('${ch.id}','${escapeHTML(ch.title)}', ${n})">üóë Delete</button>
      </td>
    </tr>`;
  }).join('') || '<tr><td colspan="3" class="small">No chapters.</td></tr>';

  const tt=$('tblTopics').querySelector('tbody');
  const byTopic=new Map(); cards.forEach(c=> (c.card_topics||[]).forEach(ct=>byTopic.set(ct.topic_id,(byTopic.get(ct.topic_id)||0)+1)));
  tt.innerHTML = topics.map(tp=>{
    const n=byTopic.get(tp.id)||0;
    return `<tr>
      <td>${escapeHTML(tp.title)}</td>
      <td>${n}</td>
      <td>
        <button class="ghost" onclick="renameTopic('${tp.id}','${escapeHTML(tp.title)}')">‚úé Edit</button>
        <button class="danger" onclick="deleteTopic('${tp.id}','${escapeHTML(tp.title)}', ${n})">üóë Delete</button>
      </td>
    </tr>`;
  }).join('') || '<tr><td colspan="3" class="small">No topics.</td></tr>';

  const tg=$('tblTags').querySelector('tbody');
  const byTag=new Map(); cards.forEach(c=> (c.card_tags||[]).forEach(t=>byTag.set(t.tag_id,(byTag.get(t.tag_id)||0)+1)));
  tg.innerHTML = tags.map(t=>{
    const n=byTag.get(t.id)||0;
    return `<tr>
      <td>${escapeHTML(t.name)}</td>
      <td>${n}</td>
      <td>
        <button class="ghost" onclick="renameTag('${t.id}','${escapeHTML(t.name)}')">‚úé Edit</button>
        <button class="danger" onclick="deleteTag('${t.id}','${escapeHTML(t.name)}', ${n})">üóë Delete</button>
      </td>
    </tr>`;
  }).join('') || '<tr><td colspan="3" class="small">No tags.</td></tr>';
}

/* Rename/Delete helpers unchanged... (same as your prior working file) */
async function renameChapter(id, oldTitle){
  const t=prompt('New chapter name:', oldTitle); if(!t||t===oldTitle) return;
  const { error } = await supabase.from('chapters').update({ title:t }).eq('id', id);
  if(error){ alert(error.message); return; }
  await loadTaxonomy(); await loadCards(); await loadUserGrades(); rebuildOrder(); renderCounts(); renderCard(); buildEditorTables(); buildScopePickers(); updateFiltersSummary();
}
async function deleteChapter(id, title, count){
  if(!confirm(`Delete chapter "${title}"?\nCards (${count}) will be left as Uncategorised.`)) return;
  const u = await supabase.from('cards').update({ chapter_id: null }).eq('chapter_id', id);
  if(u.error){ alert('Failed to uncategorise cards: '+u.error.message); return; }
  const d = await supabase.from('chapters').delete().eq('id', id);
  if(d.error){ alert('Delete failed: '+d.error.message); return; }
  await loadTaxonomy(); await loadCards(); await loadUserGrades(); rebuildOrder(); renderCounts(); renderCard(); buildEditorTables(); buildScopePickers(); updateFiltersSummary();
}
async function renameTopic(id, oldTitle){
  const t=prompt('New topic name:', oldTitle); if(!t||t===oldTitle) return;
  const { error } = await supabase.from('topics').update({ title:t }).eq('id', id);
  if(error){ alert(error.message); return; }
  await loadTaxonomy(); await loadCards(); await loadUserGrades(); rebuildOrder(); renderCounts(); renderCard(); buildEditorTables(); buildScopePickers(); updateFiltersSummary();
}
async function deleteTopic(id, title, count){
  if(!confirm(`Delete topic "${title}"?\nIt will remove links from ${count} card(s). Cards remain.`)) return;
  const j = await supabase.from('card_topics').delete().eq('topic_id', id);
  if(j.error){ alert('Failed removing links: '+j.error.message); return; }
  const d = await supabase.from('topics').delete().eq('id', id);
  if(d.error){ alert('Delete failed: '+d.error.message); return; }
  await loadTaxonomy(); await loadCards(); await loadUserGrades(); rebuildOrder(); renderCounts(); renderCard(); buildEditorTables(); buildScopePickers(); updateFiltersSummary();
}
async function renameTag(id, oldName){
  const t=prompt('New tag name:', oldName); if(!t||t===oldName) return;
  const { error } = await supabase.from('tags').update({ name:t }).eq('id', id);
  if(error){ alert(error.message); return; }
  await loadTaxonomy(); await loadCards(); buildEditorTables();
}
async function deleteTag(id, name, count){
  if(!confirm(`Delete tag "${name}"?\nIt will remove tag from ${count} card(s).`)) return;
  const j = await supabase.from('card_tags').delete().eq('tag_id', id);
  if(j.error){ alert('Failed removing tag links: '+j.error.message); return; }
  const d = await supabase.from('tags').delete().eq('id', id);
  if(d.error){ alert('Delete failed: '+d.error.message); return; }
  await loadTaxonomy(); await loadCards(); buildEditorTables();
}

/* Admin: Import (same tolerant parser) */
$('btnImport').onclick = async ()=>{
  const file = $('fileImport').files[0];
  if(!file){ alert('Pick a JSON file'); return; }
  const raw = await file.text();
  let cleaned = raw
    .replace(/\uFEFF/g, '')
    .replace(/[‚Äú‚Äù]/g, '"')
    .replace(/[‚Äò‚Äô]/g, "'")
    .replace(/\/\/.*$/mg, '')
    .replace(/\/\*[\s\S]*?\*\//g, '')
    .replace(/,\s*([}\]])/g, '$1');

  let json;
  try{ json = JSON.parse(cleaned); }catch(e){ alert('Bad JSON: '+e.message); return; }
  const list = Array.isArray(json.cards) ? json.cards : (Array.isArray(json) ? json : []);
  if(!list.length){ alert('No cards found. Expect { "cards": [...] }.'); return; }

  alert(`Importing ${list.length} cards‚Ä¶`);
  for(const c of list){
    // chapter
    let chapId = null;
    if(c.chapter){
      let { data: ex } = await supabase.from('chapters').select('id').eq('title', c.chapter).maybeSingle();
      if(!ex){ await supabase.from('chapters').insert({ title:c.chapter }); ({ data: ex } = await supabase.from('chapters').select('id').eq('title', c.chapter).maybeSingle()); }
      chapId = ex.id;
    }
    // insert card
    const payload = {
      front: c.front, back: c.back, chapter_id: chapId, meta: c.meta || {},
      status: c.status || 'published', visibility: c.visibility || 'public',
      author_suspended: !!c.author_suspended
    };
    const { data: ins, error } = await supabase.from('cards').insert(payload).select('id').single();
    if(error){ console.error('Card insert', error, c.front); continue; }
    const cardId = ins.id;

    // topics
    if(Array.isArray(c.topics) && c.topics.length){
      for(const t of c.topics){
        let { data: tx } = await supabase.from('topics').select('id').eq('title', t).maybeSingle();
        if(!tx){ await supabase.from('topics').insert({ title:t }); ({ data: tx } = await supabase.from('topics').select('id').eq('title', t).maybeSingle()); }
        await supabase.from('card_topics').insert({ card_id:cardId, topic_id:tx.id });
      }
    }
    // tags
    if(Array.isArray(c.tags) && c.tags.length){
      for(const g of c.tags){
        let { data: gx } = await supabase.from('tags').select('id').eq('name', g).maybeSingle();
        if(!gx){ await supabase.from('tags').insert({ name:g }); ({ data: gx } = await supabase.from('tags').select('id').eq('name', g).maybeSingle()); }
        await supabase.from('card_tags').insert({ card_id:cardId, tag_id:gx.id });
      }
    }
  }
  await loadTaxonomy(); await loadCards(); await loadUserGrades(); rebuildOrder(); renderCounts(); renderCard(); buildEditorTables(); buildScopePickers(); updateFiltersSummary();
  alert('Import complete.');
};

/* Admin helpers (LLM modal) ‚Äî same as your previous working file */
$('btnDownloadTemplate').onclick = ()=>{
  const template = { cards: [ { front:"Example Q?", back:"Example A.", chapter:"Chapter X", topics:["Topic A"], tags:["Definition","Format:Recall"], meta:{ Section:"Obj1" } } ] };
  const blob = new Blob([JSON.stringify(template, null, 2)], {type:'application/json'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = "cards-template.json"; a.click(); URL.revokeObjectURL(a.href);
};
$('btnOpenLLM').onclick = ()=>{
  const text = `You are generating flashcards for a Supabase-backed study app... (same prompt text you use)`;
  $('llmText').value = text; $('llmModal').style.display = 'flex';
};
$('llmClose').onclick = ()=> $('llmModal').style.display='none';
$('llmCopy').onclick = async ()=>{ try{ await navigator.clipboard.writeText($('llmText').value); alert('Copied to clipboard.'); }catch(e){ alert('Copy failed: '+e.message); } };
$('llmDownload').onclick = ()=>{ const b=new Blob([$('llmText').value],{type:'text/plain'}); const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download="LLM-instructions.txt"; a.click(); URL.revokeObjectURL(a.href); };

/* Boot */
function bindStudyChips(){ bindDiffChips(); }
async function loadAll(){
  await loadTaxonomy();
  await loadCards();
  await loadUserGrades();
  buildScopePickers();            // <-- rebuild AFTER cards to fix counts
  rebuildOrder();
  renderCounts();
  renderCard();
  bindStudyChips();
  buildEditorTables();
  // Accordion default collapsed
  $('filters').classList.remove('open');
}
window.addEventListener('DOMContentLoaded', async ()=>{
  await initAuth();
  await loadAll();
});
</script>
</body>
</html>
