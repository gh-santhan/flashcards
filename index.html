<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>LM Learner</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg:#0b0c10; --panel:#16181d; --muted:#9aa4b2; --text:#e6edf3; --accent:#3ea6ff;
      --good:#2ecc71; --hard:#f1c40f; --again:#e74c3c; --border:#222; --panel2:#0f1116;
    }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial; background:var(--bg); color:var(--text); }
    header, footer { padding:12px 16px; background: var(--panel2); border-bottom:1px solid var(--border); }
    header h1 { margin:0; font-size:16px; font-weight:600; }
    .wrap { max-width: 1200px; margin: 0 auto; padding: 16px; }
    .row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    .col { display:flex; flex-direction:column; gap:12px; }
    .card { background:var(--panel); border:1px solid var(--border); border-radius:12px; padding:20px; min-height:220px; }
    .front { font-size:18px; line-height:1.5; white-space:pre-wrap; }
    .back  { margin-top:14px; padding:14px; border-top:1px dashed #333; color:#cbd5e1; white-space:pre-wrap; display:none; }
    .controls { display:flex; gap:10px; margin-top:16px; flex-wrap:wrap; }
    button { background:#1e232b; color:var(--text); border:1px solid #2a2f37; border-radius:10px; padding:10px 12px; cursor:pointer; }
    .btn-primary { background:#16314a; border-color:#244e73; }
    button:hover { border-color:#3b4250; }
    .pill { padding:4px 8px; border-radius:999px; font-size:12px; border:1px solid #2a2f37; }
    .muted { color:var(--muted); }
    .good { border-color: var(--good); color: var(--good); }
    .hard { border-color: var(--hard); color: var(--hard); }
    .again { border-color: var(--again); color: var(--again); }
    .nav { display:flex; gap:8px; margin-top:8px; }
    .grid { display:grid; grid-template-columns: 1fr 340px; gap:16px; }
    .side { background:var(--panel2); border:1px solid var(--border); border-radius:12px; padding:12px; }
    .side h3 { margin:0 0 8px 0; font-size:14px; }
    .list { max-height: 320px; overflow:auto; border-top:1px solid var(--border); margin-top:8px; padding-top:8px; }
    .list div { font-size:13px; color:#c3cad3; display:flex; justify-content:space-between; padding:4px 0; border-bottom:1px dashed #1f232b; }
    .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; background:#151922; border:1px solid #2a2f37; padding:2px 6px; border-radius:6px; font-size:12px; color: #b7c2cf; }
    .hint { font-size:12px; color:#8e98a4; }
    .badge { background:#10131a; border:1px solid #27303a; border-radius:8px; padding:4px 6px; font-size:12px; color:#9fb2c6; }
    .auth { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    input[type="email"] { background:#11141a; border:1px solid #2a2f37; color:var(--text); border-radius:8px; padding:8px 10px; min-width:260px; }
    .note { font-size:12px; color:#9aa4b2; }
    .hidden { display:none; }
    .error { color:#ff6b6b; }
    .success { color:#2ecc71; }
    .warn { color:#f39c12; }
  </style>
  <script src="https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
</head>
<body>
  <header>
    <div class="row">
      <h1>LM Learner</h1>
      <div class="badge" id="contentVersion">content: C01-v1</div>
      <div class="muted">•</div>
      <div id="userInfo" class="muted">Checking session…</div>
    </div>
  </header>

  <div class="wrap">
    <!-- Auth Panel -->
    <section id="authPanel" class="card">
      <div class="col">
        <div class="row">
          <strong>Sign in to save your grading progress</strong>
          <div id="redirectWarn" class="note warn hidden"></div>
        </div>
        <div class="auth">
          <input id="email" type="email" placeholder="you@example.com" />
          <button class="btn-primary" id="sendMagic">Send magic link</button>
          <button id="signOut" class="hidden">Sign out</button>
        </div>
        <div id="authMsg" class="note"></div>
        <div class="note">
          The magic link redirects to the URL configured below. Ensure it’s added in Supabase → Authentication → URL Configuration.
        </div>
      </div>
    </section>

    <!-- Study UI -->
    <section id="studyUI" class="grid" style="margin-top:16px;">
      <main>
        <div class="row">
          <div class="pill">Chapter: <span id="chapterName" class="muted">—</span></div>
          <div class="pill">Topic: <span id="topicName" class="muted">—</span></div>
          <div class="pill">Card <span id="idx">0</span>/<span id="total">0</span></div>
          <div class="pill">Grade: <span id="grade" class="muted">ungraded</span></div>
          <div class="pill">Star: <span id="star" class="muted">no</span></div>
        </div>

        <section class="card" id="card">
          <div class="front" id="front">Loading…</div>
          <div class="back" id="back"></div>
          <div class="controls">
            <button id="btnShow">Show answer</button>
            <button id="btnStar" title="Toggle star">⭐ Star</button>
            <button class="again" id="btnAgain" data-grade="again">Again</button>
            <button class="hard" id="btnHard" data-grade="hard">Hard</button>
            <button class="good" id="btnGood" data-grade="good">Good</button>
            <button class="good" id="btnEasy" data-grade="easy">Easy</button>
          </div>
          <div class="nav">
            <button id="btnPrev">← Prev</button>
            <button id="btnNext">Next →</button>
          </div>
          <div class="hint">Keyboard: <span class="kbd">Space</span> show/hide, <span class="kbd">A/H/G/E</span> grade, <span class="kbd">←/→</span> nav, <span class="kbd">S</span> star.</div>
        </section>
      </main>

      <aside class="side">
        <h3>Filters</h3>
        <div class="row">
          <label><input type="checkbox" id="fltUngraded" checked> Ungraded</label>
          <label><input type="checkbox" id="fltGraded" checked> Graded</label>
          <label><input type="checkbox" id="fltStarred" checked> Starred</label>
        </div>
        <h3 style="margin-top:10px;">Counts</h3>
        <div class="list" id="counts"></div>
        <h3 style="margin-top:10px;">Session</h3>
        <div class="list" id="sessionInfo"></div>
      </aside>
    </section>
  </div>

  <footer>
    <div class="row">
      <div class="muted">Set Supabase URL, anon key, and redirect URL in the config below. Ensure your redirect is whitelisted in Supabase.</div>
    </div>
  </footer>

<script>
/* === CONFIG: UPDATE THESE === */
const SUPABASE_URL = "https://vzcgdpedoyiqzgguitum.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ6Y2dkcGVkb3lpcXpnZ3VpdHVtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkxNDA1MjksImV4cCI6MjA3NDcxNjUyOX0.hHMkwcrROCQHGlYPdfbVYmPffVHUiE838GktgXaRAzI";
const STORAGE_BUCKET = "media"; // your Storage bucket
// IMPORTANT: set this to your deployed page (e.g., GitHub Pages URL)
const REDIRECT_URL = 'https://gh-santhan.github.io/flashcards/'; // <-- change me (must match Supabase Auth → URL Configuration)

const CONTENT_VERSION = 'C01-v1';
document.getElementById('contentVersion').textContent = `content: ${CONTENT_VERSION}`;

/* ==================== Supabase client ==================== */
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
const $ = (id) => document.getElementById(id);

/* ==================== State ==================== */
let cards = [];     // all cards loaded from DB
let view = [];      // filtered subset
let idx = 0;        // current index
let current = null; // current card

/* ==================== Auth helpers ==================== */
function show(el, on=true){ el.classList.toggle('hidden', !on); }
function setAuthMsg(txt, kind='info'){
  const el = $('authMsg');
  el.textContent = txt || '';
  el.classList.remove('error','success','warn');
  if(kind==='error') el.classList.add('error');
  if(kind==='success') el.classList.add('success');
  if(kind==='warn') el.classList.add('warn');
}

function warnIfLocalhost(){
  const isLocal = location.hostname === 'localhost' || location.hostname === '127.0.0.1';
  const mismatch = isLocal && !REDIRECT_URL.includes('localhost');
  if(mismatch){
    $('redirectWarn').classList.remove('hidden');
    $('redirectWarn').textContent = `You are on localhost, but magic-link redirect is set to ${REDIRECT_URL}. Links will open that URL.`;
  } else if (!isLocal && (REDIRECT_URL.includes('localhost') || REDIRECT_URL.startsWith('file://'))) {
    $('redirectWarn').classList.remove('hidden');
    $('redirectWarn').textContent = `You are on ${location.origin}, but magic-link redirect is set to ${REDIRECT_URL}. Update REDIRECT_URL to your deployed domain.`;
  }
}

async function refreshUserUI(){
  const { data: { user }, error } = await supabase.auth.getUser();
  const userInfo = $('userInfo');
  const sessionInfo = $('sessionInfo');
  sessionInfo.innerHTML = '';
  if(error || !user){
    userInfo.textContent = 'Not signed in';
    $('signOut').classList.add('hidden');
    setAuthMsg('Sign in with a magic link to save your grading progress.');
    sessionInfo.insertAdjacentHTML('beforeend', `<div><span>Status</span><span>Anonymous</span></div>`);
  } else {
    userInfo.textContent = `Signed in: ${user.email ?? user.id}`;
    $('signOut').classList.remove('hidden');
    setAuthMsg('Signed in. Your changes are saved automatically.', 'success');
    sessionInfo.insertAdjacentHTML('beforeend', `<div><span>User</span><span>${user.email ?? user.id}</span></div>`);
  }
}

/* Magic-link sender (HARD-CODED redirect) */
$('sendMagic').onclick = async () => {
  const email = $('email').value.trim();
  if(!email){ setAuthMsg('Please enter your email address.', 'error'); return; }
  setAuthMsg(`Sending magic link to ${email}…`);
  const { error } = await supabase.auth.signInWithOtp({
    email,
    options: {
      emailRedirectTo: REDIRECT_URL,   // <-- always use your production page
      shouldCreateUser: true
    }
  });
  if(error){ setAuthMsg(`Error: ${error.message}`, 'error'); return; }
  setAuthMsg('Magic link sent. Check your inbox and click the link to return here.', 'success');
};

/* Sign out */
$('signOut').onclick = async () => {
  await supabase.auth.signOut();
  await refreshUserUI();
};

/* Handle magic-link return (clean URL) */
async function restoreSessionFromURL(){
  // supabase-js v2 parses tokens automatically on init
  const hash = window.location.hash || '';
  // remove auth fragments for a cleaner URL
  setTimeout(() => {
    if (hash.includes('access_token') || hash.includes('refresh_token') || hash.includes('type=recovery') || hash.includes('code=')) {
      history.replaceState({}, document.title, REDIRECT_URL);
    }
  }, 800);
}

/* Auth state changes */
supabase.auth.onAuthStateChange(async () => {
  await refreshUserUI();
  await mergeReviewsIntoCards();
  applyFilters();
  render();
});

/* ==================== Data loading ==================== */
async function loadCards() {
  const { data: cs, error } = await supabase
    .from('cards')
    .select(`id, front, back, chapter, topics, tags, status, visibility, author_suspended`)
    .order('created_at', { ascending: true });

  if (error) {
    $('front').textContent = 'Error loading cards.';
    console.error('cards load error:', error);
    return;
  }

  cards = (cs || []).map(c => ({
    ...c,
    user_grade: 'ungraded',
    user_starred: false
  }));

  await mergeReviewsIntoCards();
  applyFilters();
  renderCounts();
  render();
}

async function mergeReviewsIntoCards(){
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) return;

  const { data: rv, error: e2 } = await supabase
    .from('reviews')
    .select('*')
    .eq('user_id', user.id);

  if (e2) {
    console.warn('reviews load error:', e2);
    return;
  }

  if (!rv?.length) return;
  const rmap = new Map(rv.map(r => [r.card_id, r]));
  cards.forEach(c => {
    const r = rmap.get(c.id);
    if (r) {
      c.user_grade = r.grade || 'ungraded';
      c.user_starred = !!r.starred;
    }
  });
}

/* ==================== Persistence ==================== */
async function upsertReview(card) {
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) return; // allow anon usage

  const payload = {
    user_id: user.id,
    card_id: card.id,
    grade: card.user_grade || 'ungraded',
    starred: !!card.user_starred,
    last_reviewed_at: new Date().toISOString()
  };
  const { error } = await supabase.from('reviews').upsert(payload);
  if (error) console.error('review upsert failed', error);
}

/* ==================== Filters & Render ==================== */
function applyFilters() {
  const wantUngraded = $('fltUngraded').checked;
  const wantGraded   = $('fltGraded').checked;
  const wantStarred  = $('fltStarred').checked;

  view = cards.filter(c => {
    const isUngraded = (c.user_grade === 'ungraded');
    const isGraded = !isUngraded;
    const isStar = !!c.user_starred;

    const passGrade =
      (wantUngraded && isUngraded) ||
      (wantGraded && isGraded);

    const passStar =
      (wantStarred ? true : !isStar);

    return passGrade && passStar;
  });

  if (idx >= view.length) idx = Math.max(0, view.length - 1);
  current = view[idx] || null;
  renderCounts();
}

function renderCounts() {
  const total = cards.length;
  const ungraded = cards.filter(c => c.user_grade === 'ungraded').length;
  const graded = total - ungraded;
  const starred = cards.filter(c => !!c.user_starred).length;

  const el = $('counts');
  el.innerHTML = '';
  const row = (k,v) => `<div><span>${k}</span><span>${v}</span></div>`;
  el.insertAdjacentHTML('beforeend', row('Total', total));
  el.insertAdjacentHTML('beforeend', row('Ungraded', ungraded));
  el.insertAdjacentHTML('beforeend', row('Graded', graded));
  el.insertAdjacentHTML('beforeend', row('Starred', starred));

  $('total').textContent = String(view.length);
  $('idx').textContent = String(view.length ? (idx+1) : 0);
}

function render() {
  const backEl = $('back');
  if (!current) {
    $('front').textContent = 'No cards match current filters.';
    backEl.style.display = 'none';
    $('chapterName').textContent = '—';
    $('topicName').textContent = '—';
    $('grade').textContent = '—';
    $('star').textContent = '—';
    return;
  }
  $('front').textContent = current.front || '—';
  backEl.textContent  = current.back || '—';
  backEl.style.display = 'none';
  $('chapterName').textContent = current.chapter || '—';
  $('topicName').textContent = (Array.isArray(current.topics) && current.topics[0]) ? current.topics[0] : '—';
  $('grade').textContent = current.user_grade || 'ungraded';
  $('star').textContent  = current.user_starred ? 'yes' : 'no';
  $('idx').textContent = String(view.length ? (idx+1) : 0);
  $('total').textContent = String(view.length);
}

/* ==================== UI Actions ==================== */
$('btnShow').onclick = () => {
  const s = $('back').style.display;
  $('back').style.display = (s === 'none' ? 'block' : 'none');
};

$('btnPrev').onclick = () => { if (idx > 0) idx--; current = view[idx] || null; render(); };
$('btnNext').onclick = () => { if (idx < view.length-1) idx++; else idx = 0; current = view[idx] || null; render(); };

document.addEventListener('click', async (e) => {
  const btn = e.target.closest('[data-grade]');
  if (!btn || !current) return;
  const status = btn.getAttribute('data-grade'); // again | hard | good | easy
  current.user_grade = status;
  $('grade').textContent = status;
  renderCounts();
  await upsertReview(current);       // persist
  $('btnNext').click();              // advance
});

$('btnStar').onclick = async () => {
  if (!current) return;
  current.user_starred = !current.user_starred;
  $('star').textContent = current.user_starred ? 'yes' : 'no';
  renderCounts(); render();
  await upsertReview(current);
};

/* Filters */
$('fltUngraded').onchange = () => { applyFilters(); render(); };
$('fltGraded').onchange   = () => { applyFilters(); render(); };
$('fltStarred').onchange  = () => { applyFilters(); render(); };

/* Keyboard shortcuts */
document.addEventListener('keydown', async (e) => {
  if (!current) return;
  const k = e.key.toLowerCase();
  if (e.code === 'Space') { e.preventDefault(); $('btnShow').click(); }
  if (k === 'arrowleft')  $('btnPrev').click();
  if (k === 'arrowright') $('btnNext').click();
  if (k === 's') $('btnStar').click();
  if (k === 'a') { current.user_grade='again'; $('grade').textContent='again'; await upsertReview(current); $('btnNext').click(); }
  if (k === 'h') { current.user_grade='hard';  $('grade').textContent='hard';  await upsertReview(current); $('btnNext').click(); }
  if (k === 'g') { current.user_grade='good';  $('grade').textContent='good';  await upsertReview(current); $('btnNext').click(); }
  if (k === 'e') { current.user_grade='easy';  $('grade').textContent='easy';  await upsertReview(current); $('btnNext').click(); }
});

/* ==================== Boot ==================== */
(async function boot(){
  // warn if redirect mismatch
  warnIfLocalhost();

  // handle magic-link callback & clean URL
  await restoreSessionFromURL();

  // show session
  await refreshUserUI();

  // load cards + merge progress
  await loadCards();
})();
</script>
</body>
</html>
